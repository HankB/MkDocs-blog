<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Pi Zero/W with working DS18B20 - Hank's public Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Hank's public Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Hank's Docs home page</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Food <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../food/bean-dip/" class="dropdown-item">Bean Dip</a>
</li>
                                    
<li>
    <a href="../../food/peach-cobbler/" class="dropdown-item">Peach Cobbler from scratch</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Tech <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Debian_ZFS_on_root_to_a_new_drive/" class="dropdown-item">Debian Root on ZFS to a new drive</a>
</li>
                                    
<li>
    <a href="../ESP8266-RTOS-SDK_on_Debian/" class="dropdown-item">Using ESP8266-RTOS-SDK on Debian</a>
</li>
                                    
<li>
    <a href="../NVME_performance-Bicool_Mini_Base-vs-IO_Board/" class="dropdown-item">Pi CM4 NVME performance: Bicool Mini Base vs. IO Board</a>
</li>
                                    
<li>
    <a href="../OWI-535-Robot_Arm_Control_assembly/" class="dropdown-item">OWI-535 Robot Arm Control assembly</a>
</li>
                                    
<li>
    <a href="../Pi-Debian-Root-on-ZFS/" class="dropdown-item">Raspberry Pi installed with root on ZFS</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Pi Zero/W with working DS18B20</a>
</li>
                                    
<li>
    <a href="../Raspberry-Pi/" class="dropdown-item">Raspberry Pi</a>
</li>
                                    
<li>
    <a href="../TUI-challenge/" class="dropdown-item">Jupiter Broadcasting TUI challenge</a>
</li>
                                    
<li>
    <a href="../Troubleshooting-Debian-root-on-ZFS/" class="dropdown-item">Troubleshooting Debian root on ZFS</a>
</li>
                                    
<li>
    <a href="../ZBM-Void-Linux/" class="dropdown-item">Void Linux, MBR boot using ZFSBootMenu</a>
</li>
                                    
<li>
    <a href="../ZFS-boot-menu/" class="dropdown-item">ZFS boot menu</a>
</li>
                                    
<li>
    <a href="../dphacks-CM4_Ether_Board/" class="dropdown-item">dphacks CM4 Ether Board</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Raspberry Pi</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../Raspberry_Pi/Debian_on_downstream_kernel/" class="dropdown-item">Debian on downstream kernel</a>
</li>
            
<li>
    <a href="../Raspberry_Pi/Trixie_install_to_NVME/" class="dropdown-item">Trixie install to NVME</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Data</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../data/benchmarks/" class="dropdown-item">CM4 benchmarks</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Test debug <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../test-debug/Pi-4B-Bookworm-WiFi/" class="dropdown-item">Testing networking (WiFi, ETH) Pi 4B</a>
</li>
                                    
<li>
    <a href="../../test-debug/Pi-4B-Bookworm-testing/" class="dropdown-item">Pi 4B Bookworm testing</a>
</li>
                                    
<li>
    <a href="../../test-debug/Pi-4B-KDE_bookworm/" class="dropdown-item">KDE Plasma X11 login hang</a>
</li>
                                    
<li>
    <a href="../../test-debug/Pi-4B-firmware/" class="dropdown-item">Firmware issue raspi-firmware Debian Bookworm</a>
</li>
                                    
<li>
    <a href="../../test-debug/Pi-firmware-2024-04-28/" class="dropdown-item">Pi Firmware 2024-04-28</a>
</li>
                                    
<li>
    <a href="../../test-debug/Pi-new-CM4-WiFi-debugging/" class="dropdown-item">New Raspberry Pi CM4 WiFi testing</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Pi CM4 PCIe</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../test-debug/Pi-CM4-PCIe/Pi_CM4_PCIe_testing/" class="dropdown-item">Pi CM4 PCIe testing</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Sanoid</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../test-debug/Sanoid/sanoid/" class="dropdown-item">Sanoid issue #813 testing</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Pi-Debian-Root-on-ZFS/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Raspberry-Pi/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#pi-zerow-with-working-ds18b20" class="nav-link">Pi Zero/W with working DS18B20</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#2024-10-24-further-direction-via-irc" class="nav-link">2024-10-24 further direction via IRC</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2024-10-25-dtbo-naming" class="nav-link">2024-10-25 dtbo naming</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2024-11-05-works-with-rpios" class="nav-link">2024-11-05 Works with RpiOS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2024-11-21-repeat-following-kernel-upgrade" class="nav-link">2024-11-21 repeat following kernel upgrade</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="pi-zerow-with-working-ds18b20">Pi Zero/W with working DS18B20</h1>
<p>Uses a 1-wire temperture sensor. Desire to get working on a Pi Zero W running Debian (not RpiOS.)</p>
<p>Following up on a discussion initiated on <code>#debian-raspberrypi</code>.</p>
<p>Fully up to date Debian install with the following kernel</p>
<pre><code class="language-text">hbarta@ceres:~$ uname -a
Linux ceres 6.1.0-26-rpi #1 Debian 6.1.112-1 (2024-09-30) armv6l GNU/Linux
hbarta@ceres:~$
</code></pre>
<p><code>ukleinek</code> suggests "bookworm kernel is fine. 6.1.94-1 is the first good kernel." so I shouyld be good here.</p>
<pre><code class="language-text">root@ceres:~# cat /sys/kernel/debug/devices_deferred
root@ceres:~#

root@ceres:~# modprobe w1_therm

root@ceres:~# lsmod|grep -E &quot;wire|w1&quot;
w1_therm               28672  0
wire                   45056  1 w1_therm
root@ceres:~# 

root@ceres:~# ls -lR /sys/bus/w1/
/sys/bus/w1/:
total 0
drwxr-xr-x 2 root root    0 Oct 23 15:25 devices
drwxr-xr-x 4 root root    0 Oct 23 15:25 drivers
-rw-r--r-- 1 root root 4096 Oct 23 15:25 drivers_autoprobe
--w------- 1 root root 4096 Oct 23 15:25 drivers_probe
--w------- 1 root root 4096 Oct 23 15:25 uevent

/sys/bus/w1/devices:
total 0

/sys/bus/w1/drivers:
total 0
drwxr-xr-x 2 root root 0 Oct 23 15:25 w1_master_driver
drwxr-xr-x 2 root root 0 Oct 23 15:25 w1_slave_driver

/sys/bus/w1/drivers/w1_master_driver:
total 0
--w------- 1 root root 4096 Oct 23 15:26 bind
--w------- 1 root root 4096 Oct 23 15:25 uevent
--w------- 1 root root 4096 Oct 23 15:26 unbind

/sys/bus/w1/drivers/w1_slave_driver:
total 0
--w------- 1 root root 4096 Oct 23 15:26 bind
--w------- 1 root root 4096 Oct 23 15:25 uevent
--w------- 1 root root 4096 Oct 23 15:26 unbind
root@ceres:~# 
</code></pre>
<pre><code class="language-text">ukleinek starrs at w1-gpio.dtbo # presume 'starts'
</code></pre>
<p>This one? <a href="https://github.com/raspberrypi/firmware/blob/master/boot/overlays/w1-gpio.dtbo">https://github.com/raspberrypi/firmware/blob/master/boot/overlays/w1-gpio.dtbo</a></p>
<p><a href="https://github.com/raspberrypi/linux/blob/rpi-6.6.y/arch/arm/boot/dts/overlays/w1-gpio-overlay.dts">https://github.com/raspberrypi/linux/blob/rpi-6.6.y/arch/arm/boot/dts/overlays/w1-gpio-overlay.dts</a></p>
<p>Compile:</p>
<pre><code class="language-text">hbarta@ceres:~/Documents/w1$ dtc w1-gpio-overlay.dts -o w1-gpio-overlay.dtb
w1-gpio-overlay.dts:12.18-18.6: Warning (unit_address_vs_reg): /fragment@0/__overlay__/onewire@0: node has a unit name, but no reg or ranges property
w1-gpio-overlay.dts:25.23-29.6: Warning (unit_address_vs_reg): /fragment@1/__overlay__/w1_pins@0: node has a unit name, but no reg or ranges property
hbarta@ceres:~/Documents/w1$ ls -l
total 8
-rw-r--r-- 1 hbarta hbarta 909 Oct 23 15:56 w1-gpio-overlay.dtb
-rw-r--r-- 1 hbarta hbarta 699 Oct 23 15:55 w1-gpio-overlay.dts
hbarta@ceres:~/Documents/w1$ 

</code></pre>
<pre><code class="language-text">[15:45] &lt;ukleinek&gt; HankB: you can test if it applies using `fdtoverlay -i /boot/firmware/yourmachine.dtb -o /tmp/lala.dtb /boot/firmware/overlays/w1-gpio.dtbo`
</code></pre>
<pre><code class="language-text">fdtoverlay -i /boot/firmware/bcm2835-rpi-zero-w.dtb -o /tmp/lala.dtb /boot/firmware/overlays/w1-gpio-overlay.dtbo
</code></pre>
<p><code>fdtoverlay</code> produces no errors or warnings.</p>
<pre><code class="language-text">hbarta@ceres:~/Documents/w1$ sudo mkdir /boot/firmware/overlays/
hbarta@ceres:~/Documents/w1$ sudo cp w1-gpio-overlay.dtbo /boot/firmware/overlays/
hbarta@ceres:~/Documents/w1$ 
</code></pre>
<p>Does not seem to change anything. Try moving the <code>w1-gpio-overlay.dtbo</code> to <code>/boot/firmware</code>. Seems to make no difference. Moving it back and looking at modules. RpiOS shows</p>
<pre><code class="language-text">hbarta@niwot:~ $ lsmod|grep -E &quot;wire|w1&quot;
w1_therm               17732  0
w1_gpio                 3165  0
wire                   32902  2 w1_gpio,w1_therm
cn                      6073  1 wire
hbarta@niwot:~ $ 
</code></pre>
<p>No joy</p>
<pre><code class="language-text">root@ceres:/home/hbarta# modprobe w1_therm wire w1_gpio cn
root@ceres:/home/hbarta# cat /sys/kernel/debug/devices_deferred
root@ceres:/home/hbarta# ls /sys/bus/w1/devices/
root@ceres:/home/hbarta# 
</code></pre>
<p><code>file</code> describes the <code>.dtbo</code></p>
<pre><code class="language-text">root@ceres:~# file /boot/firmware/overlays/w1-gpio-overlay.dtbo 
/boot/firmware/overlays/w1-gpio-overlay.dtbo: Device Tree Blob version 17, size=909, boot CPU=0, string block size=129, DT structure block size=724
root@ceres:~# 
</code></pre>
<h2 id="2024-10-24-further-direction-via-irc">2024-10-24 further direction via IRC</h2>
<pre><code class="language-text">[23:28] &lt;ukleinek&gt; HankB: /boot/firmware/overlays is irrelevant. That only matters if the kernel applies an overlay. You however want the overlay applied by the bootloader.
[23:29] &lt;ukleinek&gt; HankB: so place the overlay in /boot/firmware/overlays and add dtoverlay=w1-gpio to config.txt
[23:31] &lt;ukleinek&gt; If that worked you should have a dir /sys/firmware/devicetree/base/onewire@0
...
[03:19] &lt;sur5r&gt; ukleinek: those sentences contradict themselves. &quot;/boot/firmware/overlays is irrelevant&quot; &lt;-&gt; &quot;place the overlay in /boot/firmware/overlays and add dtoverlay=w1-gpio to config.txt&quot;
[03:20] &lt;ukleinek&gt; oh, indeed, it's /sys/firmware/devicetree/overlays that is irrelevant
[03:21] &lt;ukleinek&gt; I missread that and my copy-and-paste didn't follow my misinterpretation.
[03:23] &lt;sur5r&gt; I don't have /sys/firmware/devicetree/overlays
[03:23] &lt;sur5r&gt; Is that an RpiOS thing?
[03:24] &lt;sur5r&gt; I would love to be able to load DTBOs at runtime but never understood how to do that on Debian.
[03:26] &lt;ukleinek&gt; sur5r: there is a patch set for dynamic dtbo application from userspace, but no chance to get that into mainline. Many drivers assume the dtb doesn't change and keep references to it. Even if they maintain pointers to unrelated parts of the dtb their offset might change (I think), so that's calling for data corruption.
[03:27] &lt;ukleinek&gt; https://git.kernel.org/pub/scm/linux/kernel/git/geert/renesas-drivers.git/log/?h=topic/overlays is the most maintained version of if AFAIK
[03:30] &lt;ukleinek&gt; There is an in-kernel API though, and if you use that, /sys/firmware/devicetree/overlays is created. (Dangerous half knowledge. That is at least the reason the dtb is in /sys/firmware/devicetree/base and not in /sys/firmware/devicetree/ directly)
[03:32] &lt;jochensp&gt; ukleinek: do you mean CONFIG_OF_DYNAMIC?
[03:32] &lt;ukleinek&gt; Yes, that's the in-kernel one
[03:35] &lt;ukleinek&gt; ah, /sys/firmware/devicetree/overlays only comes into play with the above mentioned patches applied.
[03:47] &lt;sur5r&gt; Yeah I remember the RaspiOS tool warns loudly when trying to remove dtbos
[05:24] &lt;sur5r&gt; *sigh* fbtft can't be built OOT against the Debian kernel as it needs FB_BACKLIGHT enabled
</code></pre>
<pre><code class="language-text">root@ceres:~# tail /boot/firmware/config.txt 
enable_uart=1
upstream_kernel=1

kernel=vmlinuz-6.1.0-26-rpi
# For details on the initramfs directive, see
# https://www.raspberrypi.org/forums/viewtopic.php?f=63&amp;t=10532
initramfs initrd.img-6.1.0-26-rpi

#dtoverlay=w1-gpio.gpiopin=4
dtoverlay=w1-gpio
root@ceres:~# ls -l /sys/firmware/devicetree/overlays
ls: cannot access '/sys/firmware/devicetree/overlays': No such file or directory
root@ceres:~# ls -l /sys/firmware/devicetree/        
total 0
drwxr-xr-x 17 root root 0 Aug 25 12:35 base
root@ceres:~# ls -l /sys/firmware/devicetree/base
total 0
-r--r--r--  1 root root  4 Oct 24 09:43 '#address-cells'
-r--r--r--  1 root root  4 Oct 24 09:43 '#size-cells'
drwxr-xr-x  2 root root  0 Oct 24 09:43  __symbols__
drwxr-xr-x  2 root root  0 Oct 24 09:43  aliases
drwxr-xr-x  2 root root  0 Oct 24 09:43  arm-pmu
drwxr-xr-x  3 root root  0 Oct 24 09:43  axi
drwxr-xr-x  4 root root  0 Oct 24 09:43  chosen
drwxr-xr-x  4 root root  0 Oct 24 09:43  clocks
-r--r--r--  1 root root 38 Aug 25 12:35  compatible
drwxr-xr-x  3 root root  0 Oct 24 09:43  cpus
-r--r--r--  1 root root  4 Oct 24 09:43  interrupt-parent
drwxr-xr-x  3 root root  0 Oct 24 09:43  leds
drwxr-xr-x  2 root root  0 Oct 24 09:43  memory@0
-r--r--r--  1 root root  8 Oct 24 09:43  memreserve
-r--r--r--  1 root root 28 Oct 24 09:43  model
-r--r--r--  1 root root  1 Oct 24 09:43  name
drwxr-xr-x  2 root root  0 Oct 24 09:43  phy
drwxr-xr-x  3 root root  0 Oct 24 09:43  reserved-memory
-r--r--r--  1 root root 17 Oct 24 09:43  serial-number
drwxr-xr-x 40 root root  0 Oct 24 09:43  soc
drwxr-xr-x  2 root root  0 Oct 24 09:43  system
drwxr-xr-x  3 root root  0 Oct 24 09:43  thermal-zones
drwxr-xr-x  2 root root  0 Oct 24 09:43  wifi-pwrseq
root@ceres:~# 
</code></pre>
<p>Reboot now</p>
<pre><code class="language-text">root@ceres:~# ls -l /sys/firmware/devicetree/overlays
ls: cannot access '/sys/firmware/devicetree/overlays': No such file or directory
root@ceres:~# tail -1 /boot/firmware/config.txt 
dtoverlay=w1-gpio
root@ceres:~# for m in  w1_therm wire w1_gpio cn; do modprobe $m; done
root@ceres:~# ls -l /sys/firmware/devicetree/overlays
ls: cannot access '/sys/firmware/devicetree/overlays': No such file or directory
root@ceres:~# 
</code></pre>
<p>Further checking</p>
<pre><code class="language-text">root@ceres:/home/hbarta# find /sys -name &quot;onewire*&quot;
root@ceres:/home/hbarta# find /sys -name &quot;one*&quot;
root@ceres:/home/hbarta# find /sys -name &quot;wire*&quot;
/sys/devices/platform/soc/20300000.mmc/mmc_host/mmc1/mmc1:0001/mmc1:0001:1/net/wlan0/wireless
/sys/module/wire
root@ceres:/home/hbarta# find /sys -name &quot;w1*&quot;  
/sys/bus/platform/drivers/w1-gpio
/sys/bus/w1
/sys/bus/w1/drivers/w1_slave_driver
/sys/bus/w1/drivers/w1_master_driver
/sys/module/w1_gpio
/sys/module/wire/holders/w1_gpio
/sys/module/wire/holders/w1_therm
/sys/module/w1_therm
root@ceres:/home/hbarta# 
</code></pre>
<h2 id="2024-10-25-dtbo-naming">2024-10-25 dtbo naming</h2>
<pre><code class="language-text">dtc w1-gpio-overlay.dts -o w1-gpio.dtbo
sudo cp w1-gpio.dtbo
# Check /boot/firmware/config.txt
</code></pre>
<pre><code class="language-text">hbarta@ceres:~/Documents/w1$ dtc w1-gpio-overlay.dts -o w1-gpio.dtbo
w1-gpio-overlay.dts:12.18-18.6: Warning (unit_address_vs_reg): /fragment@0/__overlay__/onewire@0: node has a unit name, but no reg or ranges property
w1-gpio-overlay.dts:25.23-29.6: Warning (unit_address_vs_reg): /fragment@1/__overlay__/w1_pins@0: node has a unit name, but no reg or ranges property
hbarta@ceres:~/Documents/w1$ sudo cp w1-gpio.dtbo /boot/firmware/overlays
[sudo] password for hbarta: 
hbarta@ceres:~/Documents/w1$ tail -1 /boot/firmware/config.txt 
dtoverlay=w1-gpio
hbarta@ceres:~/Documents/w1$ sudo shutdown -r now
</code></pre>
<p>Following reboot:</p>
<pre><code class="language-text">Linux ceres 6.1.0-26-rpi #1 Debian 6.1.112-1 (2024-09-30) armv6l
...
Last login: Fri Oct 25 08:30:42 2024 from 192.168.1.85
hbarta@ceres:~$ lsmod | grep w1     
w1_gpio                16384  0
wire                   45056  1 w1_gpio
hbarta@ceres:~$ ls /sys/bus/w1/devices/
hbarta@ceres:~$ cat /boot/firmware/config.txt
# Do not modify this file!
#
# It is automatically generated upon install or update of either the
# firmware or the Linux kernel.
#
# If you need to set boot-time parameters, do so via the
# /etc/default/raspi-firmware, /etc/default/raspi-firmware-custom or
# /etc/default/raspi-extra-cmdline files.

enable_uart=1
upstream_kernel=1

kernel=vmlinuz-6.1.0-26-rpi
# For details on the initramfs directive, see
# https://www.raspberrypi.org/forums/viewtopic.php?f=63&amp;t=10532
initramfs initrd.img-6.1.0-26-rpi

#dtoverlay=w1-gpio.gpiopin=4
dtoverlay=w1-gpio
hbarta@ceres:~$ ls /boot/firmware/overlays
w1-gpio.dtbo
hbarta@ceres:~$ cat /sys/kernel/debug/devices_deferred
cat: /sys/kernel/debug/devices_deferred: Permission denied
hbarta@ceres:~$ sudo cat /sys/kernel/debug/devices_deferred
[sudo] password for hbarta: 
hbarta@ceres:~$ ls -l /sys/firmware/devicetree/overlays
ls: cannot access '/sys/firmware/devicetree/overlays': No such file or directory
hbarta@ceres:~$ 
hbarta@ceres:~$ sudo modprobe w1_therm
hbarta@ceres:~$ ls -l /sys/firmware/devicetree/overlays
ls: cannot access '/sys/firmware/devicetree/overlays': No such file or directory
hbarta@ceres:~$ ls /sys/bus/w1/devices/
hbarta@ceres:~$ lsmod | grep w1
w1_therm               28672  0
w1_gpio                16384  0
wire                   45056  2 w1_gpio,w1_therm
hbarta@ceres:~$ 
</code></pre>
<p>Difference: module <code>w1_gpio</code> loaded automatically. <code>w1_therm</code> did not.</p>
<pre><code class="language-text">fdtoverlay -i /boot/firmware/bcm2835-rpi-zero-w.dtb -o /tmp/lala.dtb /boot/firmware/overlays/w1-gpio.dtbo
</code></pre>
<p>Produces no errors/warnings</p>
<h3 id="more">More</h3>
<pre><code class="language-text">[09:50] &lt;jochensp&gt; hbarta_: you could try the raspberry kernel dtb and then debug which part mainline is missing
[09:53] &lt;hbarta_&gt; I'll take a look at that - thx. I think I tried that at one point but might have fumbled something.
[09:54] &lt;hbarta_&gt; Actually, this is the DTS pulled from the RpiOS repo that I'm using.
[09:59] &lt;jochensp&gt; hbarta_: I mean the complete dtb, not only the overlay
[10:00] &lt;-- chele (~chele@00022067.user.oftc.net) has left this server (Remote host closed the connection).
[10:00] &lt;-- minimal (~minimal@0002b71e.user.oftc.net) has left this server (Quit: Leaving).
[10:06] &lt;ukleinek&gt; hbarta_: the warnings don't matter
[10:06] &lt;ukleinek&gt; s/warnings/&amp; by dtc/
[10:07] &lt;ukleinek&gt; no, don't pollute you system with rpi stuff :-)
[10:08] &lt;jochensp&gt; ukleinek: feel free to propose a better way but that's how I found the missing peaces last time ;)
[10:08] &lt;hbarta_&gt; I don't kow what you mean by &quot;complete dtb&quot; Is that the contents of the directory I pulled the DTS from
[10:09] &lt;hbarta_&gt; The DTS I'm working with is from an Rpi repo.
[10:10] &lt;ukleinek&gt; hbarta_: dmesg | grep -E onewire
[10:11] * ukleinek expects a problem with pinctrl
[10:11] &lt;ukleinek&gt; hbarta_: jochensp suggests to replace the machine dtb.
[10:13] &lt;ukleinek&gt; &quot;module w1_gpio loaded automatically. w1_therm did not.&quot; is not surprising.
[10:13] &lt;hbarta_&gt; I tried (what I believe) is the machine DTB from a Pi with 6.6 kernel and the Pi stuck at the rainbow screen.
[10:14] &lt;ukleinek&gt; because there is a w1-gpio device now (that however fails to probe because of a pinctrl conflict) and as the bus is missing there is no therm device that would trigger autoloading w1-therm
[10:15] &lt;hbarta_&gt; 3 lines from the grep dmesg
[10:16] &lt;hbarta_&gt; [   35.169615] pinctrl-bcm2835 20200000.gpio: pin gpio4 already requested by 20200000.gpio; cannot claim for onewire@0
[10:16] &lt;hbarta_&gt; [   35.195280] pinctrl-bcm2835 20200000.gpio: pin-4 (onewire@0) status -22
[10:16] &lt;hbarta_&gt; [   35.242269] w1-gpio onewire@0: Error applying setting, reverse things back
[10:16] &lt;hbarta_&gt; Seems significant.
[10:16] &lt;ukleinek&gt; it is
[10:17] &lt;hbarta_&gt; Can you suggest a fix?
[10:17] * ukleinek is working at it
[10:17] &lt;hbarta_&gt; Thx
</code></pre>
<p>Working! <a href="https://paste.debian.net/hidden/d5ad73b2/">https://paste.debian.net/hidden/d5ad73b2/</a></p>
<pre><code class="language-text">diff --git a/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts b/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts
index 1f0b163e400c..9ee4ffc1cd38 100644
--- a/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts
+++ b/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts
@@ -98,7 +98,7 @@ &amp;gpio {
              &quot;SD_DATA3_R&quot;;

    pinctrl-names = &quot;default&quot;;
-   pinctrl-0 = &lt;&amp;gpioout &amp;alt0&gt;;
+   pinctrl-0 = &lt;&amp;gpioout&gt;;
 };

 &amp;hdmi {
</code></pre>
<ul>
<li>Pi Zero <a href="https://github.com/torvalds/linux/blob/master/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero.dts">https://github.com/torvalds/linux/blob/master/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero.dts</a></li>
<li>Pi Zero W<a href="https://github.com/torvalds/linux/blob/master/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts">https://github.com/torvalds/linux/blob/master/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts</a></li>
</ul>
<p>(Note: <code>wget</code> the raw URL.)</p>
<p>I need to repeat this, perhaps for other Pi models to confirm I have the needed fixes and repeatable instructions.</p>
<p>Again, many thanks to the denizens of the #debian-raspberrypi who solved this for me.</p>
<h2 id="2024-11-05-works-with-rpios">2024-11-05 Works with RpiOS</h2>
<pre><code class="language-text">[16:40] &lt;ukleinek&gt; HankB: I would be interested if the w1-gpio overlay works for the pizero using rpios.
[16:43] &lt;-- leighbb (~leighbb@2001:8b0:1df6:8fca:bab9:33:f4b0:28ef) has left this server (Quit: Leaving).
[16:43] &lt;ukleinek&gt; HankB: sounds as if you'd need access to your vanishing pizeros via an UART console. What do you use to configure the wifi connection? nm? networkd?
[16:44] &lt;ukleinek&gt; Maybe a reconnect issue? Did you try to disable the wifi shortly and then check if the device reconnect?
</code></pre>
<h2 id="2024-11-21-repeat-following-kernel-upgrade">2024-11-21 repeat following kernel upgrade</h2>
<ul>
<li>Not on a fresh install.</li>
<li>On a Zero W host <code>ceres</code>.</li>
<li>Version of DTB files seems to be the same (e.g. <bcm2835-rpi-...>)</li>
<li>DS18B20 device no longer present.</li>
</ul>
<pre><code class="language-text">cd ~/GPIO
wget https://raw.githubusercontent.com/torvalds/linux/refs/heads/master/arch/arm/boot/dts/broadcom/bcm2835-rpi-zero-w.dts
dtc bcm2835-rpi-zero-w.dts -o bcm2835-rpi-zero-w.dtb
</code></pre>
<p>Last command produces the error </p>
<pre><code class="language-text">hbarta@ceres:~/GPIO$ dtc bcm2835-rpi-zero-w.dts
Error: bcm2835-rpi-zero-w.dts:7.1-9 syntax error
FATAL ERROR: Unable to parse input tree
hbarta@ceres:~/GPIO$ 
</code></pre>
<p>However, after adding <code>dtoverlay=w1-gpio</code> to <code>config.txt</code> the DS18B20 device is present (following reboot.) (IOW the kernel upgrade replaced config.txt but left the DTB as is.)</p>
<p>```text
dtc bcm2835-rpi-zero-w.dts -O dtb 
dtc -I dts -O dtb bcm2835-rpi-zero-w.dts bcm2835-rpi-zero-w.dtb
gcc -E -O dtb bcm2835-rpi-zero-w.dts -o bcm2835-rpi-zero-w.dtb</p>
<p>dtc -I dts -O dtb bcm2835-rpi-zero-w.dts bcm2835-rpi-zero-w.dtb
dtc -I dtb -O dts -o bcm2835-rpi-zero-w.dts bcm2835-rpi-zero-w.dtb
dtc -I dts -O dtb bcm2835-rpi-zero-w.dts -o bcm2835-rpi-zero-w-1.dtb</p>
<p>[11:45] <ukleinek> the kernel rule is cmd_dtc in scripts/Makefile.dtbs</p>
<p>(Present status is incomplete.)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
