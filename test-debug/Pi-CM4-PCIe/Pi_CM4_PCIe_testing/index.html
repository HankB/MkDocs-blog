<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Pi CM4 PCIe testing - Hank's public Docs</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Hank's public Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Hank's Docs home page</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Food</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../food/bean-dip/" class="dropdown-item">Bean Dip</a>
</li>
                                    
<li>
    <a href="../../../food/peach-cobbler/" class="dropdown-item">Peach Cobbler from scratch</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Tech</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../tech/Debian_ZFS_on_root_to_a_new_drive/" class="dropdown-item">Debian Root on ZFS to a new drive</a>
</li>
                                    
<li>
    <a href="../../../tech/Debian_on_downstream_kernel/" class="dropdown-item">Debian on downstream kernel</a>
</li>
                                    
<li>
    <a href="../../../tech/ESP8266-RTOS-SDK_on_Debian/" class="dropdown-item">Using ESP8266-RTOS-SDK on Debian</a>
</li>
                                    
<li>
    <a href="../../../tech/NVME_performance-Bicool_Mini_Base-vs-IO_Board/" class="dropdown-item">Pi CM4 NVME performance: Bicool Mini Base vs. IO Board</a>
</li>
                                    
<li>
    <a href="../../../tech/OWI-535-Robot_Arm_Control_assembly/" class="dropdown-item">OWI-535 Robot Arm Control assembly</a>
</li>
                                    
<li>
    <a href="../../../tech/Pi-Debian-Root-on-ZFS/" class="dropdown-item">Raspberry Pi installed with root on ZFS</a>
</li>
                                    
<li>
    <a href="../../../tech/Pi-Zero_Debian_DS18B20/" class="dropdown-item">Pi Zero/W with working DS18B20</a>
</li>
                                    
<li>
    <a href="../../../tech/Raspberry-Pi/" class="dropdown-item">Raspberry Pi</a>
</li>
                                    
<li>
    <a href="../../../tech/TUI-challenge/" class="dropdown-item">Jupiter Broadcasting TUI challenge</a>
</li>
                                    
<li>
    <a href="../../../tech/Trixie_install_to_NVME/" class="dropdown-item">Trixie install to NVME</a>
</li>
                                    
<li>
    <a href="../../../tech/Troubleshooting-Debian-root-on-ZFS/" class="dropdown-item">Troubleshooting Debian root on ZFS</a>
</li>
                                    
<li>
    <a href="../../../tech/ZBM-Void-Linux/" class="dropdown-item">Void Linux, MBR boot using ZFSBootMenu</a>
</li>
                                    
<li>
    <a href="../../../tech/ZFS-boot-menu/" class="dropdown-item">ZFS boot menu</a>
</li>
                                    
<li>
    <a href="../../../tech/dphacks-CM4_Ether_Board/" class="dropdown-item">dphacks CM4 Ether Board</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Data</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../tech/data/benchmarks/" class="dropdown-item">CM4 benchmarks</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Test debug</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Pi-4B-Bookworm-WiFi/" class="dropdown-item">Testing networking (WiFi, ETH) Pi 4B</a>
</li>
                                    
<li>
    <a href="../../Pi-4B-Bookworm-testing/" class="dropdown-item">Pi 4B Bookworm testing</a>
</li>
                                    
<li>
    <a href="../../Pi-4B-KDE_bookworm/" class="dropdown-item">KDE Plasma X11 login hang</a>
</li>
                                    
<li>
    <a href="../../Pi-4B-firmware/" class="dropdown-item">Firmware issue raspi-firmware Debian Bookworm</a>
</li>
                                    
<li>
    <a href="../../Pi-firmware-2024-04-28/" class="dropdown-item">Pi Firmware 2024-04-28</a>
</li>
                                    
<li>
    <a href="../../Pi-new-CM4-WiFi-debugging/" class="dropdown-item">New Raspberry Pi CM4 WiFi testing</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Pi CM4 PCIe</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Pi CM4 PCIe testing</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Sanoid</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Sanoid/sanoid/" class="dropdown-item">Sanoid issue #813 testing</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../Pi-new-CM4-WiFi-debugging/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../Sanoid/sanoid/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#pi-cm4-pcie-testing" class="nav-link">Pi CM4 PCIe testing</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#purpose" class="nav-link">Purpose</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#results-as-of-2023-03-28" class="nav-link">Results as of 2023-03-28</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#nvme-details" class="nav-link">NVME details</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2023-03-28-serial-debug" class="nav-link">2023-03-28 Serial debug</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2023-03-29-focus-on-sd-boot-failure-when-pcie-card-is-present" class="nav-link">2023-03-29 focus on SD boot failure when PCIe card is present</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#todo" class="nav-link">TODO</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="pi-cm4-pcie-testing">Pi CM4 PCIe testing</h1>
<h2 id="purpose">Purpose</h2>
<p>Test Debian Bookworm on a Pi CM4 with (and booting from) an NVME adapter and two SATA adapters in the "Compute Module 4 IO Board"</p>
<h2 id="results-as-of-2023-03-28">Results as of 2023-03-28</h2>
<h3 id="nvme-with-ssd">NVME with SSD</h3>
<p>System boots from NVME and works as expected. The system will <em>not</em> boot from SD card when the PCIe/NVME adapter is installed.</p>
<h3 id="asmedia-pciesata-adapter">ASMedia PCIe/SATA adapter</h3>
<p>Boot from SD card works 3-4 times out of 5. Other times halts with a blank screen following the "rainbow screen." When a SATA SSD is connected (when  booting from SD) it appears to work.</p>
<p>Boot from SSD was unsuccessful. The "rainbow screen" did not appear but the subsequent (BIOS) screen looping through possible boot modes (<code>NETWORK</code> and <code>BCM-USB-MSD</code>) At some point something was printed to the serial port but it looked like a single character at the wrong baud rate.</p>
<p>Many times the system was power cycled with both SD card in place and SSD connected and the result was a blank screen and no serial output. Once the system came up and appeared to boot from the SD card and find root on the SSD. After sevaral tries I duplicated that and captured the <a href="../minicom-SD_boot-SSD_root.cap.txt">serial output.</a></p>
<pre><code class="language-text">root@cm4iob:~# lspci -v
00:00.0 PCI bridge: Broadcom Inc. and subsidiaries BCM2711 PCIe Bridge (rev 20) (prog-if 00 [Normal decode])
        Flags: bus master, fast devsel, latency 0, IRQ 23
        Bus: primary=00, secondary=01, subordinate=01, sec-latency=0
        Memory behind bridge: 00000000-000fffff [size=1M] [32-bit]
        Prefetchable memory behind bridge: [disabled] [64-bit]
        Capabilities: [48] Power Management version 3
        Capabilities: [ac] Express Root Port (Slot-), MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [180] Vendor Specific Information: ID=0000 Rev=0 Len=028 &lt;?&gt;
        Capabilities: [240] L1 PM Substates
        Kernel driver in use: pcieport

01:00.0 SATA controller: ASMedia Technology Inc. Device 1064 (rev 02) (prog-if 01 [AHCI 1.0])
        Subsystem: ZyDAS Technology Corp. Device 2116
        Flags: bus master, fast devsel, latency 0, IRQ 38
        Memory at 600080000 (32-bit, non-prefetchable) [size=8K]
        Memory at 600082000 (32-bit, non-prefetchable) [size=8K]
        Expansion ROM at 600000000 [virtual] [disabled] [size=512K]
        Capabilities: [40] Power Management version 3
        Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit+
        Capabilities: [80] Express Endpoint, MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [130] Secondary PCI Express
        Kernel driver in use: ahci
        Kernel modules: ahci

root@cm4iob:~# 
</code></pre>
<h3 id="marvel-pciesata-adapter">Marvel PCIe/SATA adapter</h3>
<p>Unable to boot from SD card when this adapter is in the PCIe slot. The "rainbow screen" appears and the screen goes blank with no further (on screen) behavior. With no SD card in the slot, the firmware cycles through boot options until it gets to PXE boot and then repeats the cycle.</p>
<p>With the SD card removed and a bootable SSD connected to the adapter, the "rainbow screen" does not appear and there is no output to the serial port.</p>
<p>Card dettails (from R-Pi OS)</p>
<pre><code class="language-text">root@piserver:~# lspci -v
00:00.0 PCI bridge: Broadcom Inc. and subsidiaries BCM2711 PCIe Bridge (rev 20) (prog-if 00 [Normal decode])
        Device tree node: /sys/firmware/devicetree/base/scb/pcie@7d500000/pci@0,0
        Flags: bus master, fast devsel, latency 0
        Bus: primary=00, secondary=01, subordinate=01, sec-latency=0
        I/O behind bridge: 00000000-00000fff [size=4K]
        Memory behind bridge: c0000000-c00fffff [size=1M]
        Prefetchable memory behind bridge: [disabled]
        Capabilities: [48] Power Management version 3
        Capabilities: [ac] Express Root Port (Slot-), MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [180] Vendor Specific Information: ID=0000 Rev=0 Len=028 &lt;?&gt;
        Capabilities: [240] L1 PM Substates

01:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9215 PCIe 2.0 x1 4-port SATA 6 Gb/s Controller (rev 11) (prog-if 01 [AHCI 1.0])
        Subsystem: Marvell Technology Group Ltd. 88SE9215 PCIe 2.0 x1 4-port SATA 6 Gb/s Controller
        Device tree node: /sys/firmware/devicetree/base/scb/pcie@7d500000/pci@0,0/usb@0,0
        Flags: bus master, fast devsel, latency 0, IRQ 67
        I/O ports at 0000
        I/O ports at 0000
        I/O ports at 0000
        I/O ports at 0000
        I/O ports at 0000
        Memory at 600010000 (32-bit, non-prefetchable) [size=2K]
        Expansion ROM at 600000000 [disabled] [size=64K]
        Capabilities: [40] Power Management version 3
        Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit-
        Capabilities: [70] Express Legacy Endpoint, MSI 00
        Capabilities: [e0] SATA HBA v0.0
        Capabilities: [100] Advanced Error Reporting
        Kernel driver in use: ahci
        Kernel modules: ahci

root@piserver:~#
</code></pre>
<p>Capture of <a href="../minicom-SD_Raspbian-Marvell.cap.txt">serial output</a> during R-Pi OS boot.</p>
<h2 id="nvme-details">NVME details</h2>
<pre><code class="language-text">root@debnvme:~# lspci -v
00:00.0 PCI bridge: Broadcom Inc. and subsidiaries BCM2711 PCIe Bridge (rev 20) (prog-if 00 [Normal decode])
        Flags: bus master, fast devsel, latency 0, IRQ 23
        Bus: primary=00, secondary=01, subordinate=01, sec-latency=0
        Memory behind bridge: 00000000-000fffff [size=1M] [32-bit]
        Prefetchable memory behind bridge: [disabled] [64-bit]
        Capabilities: [48] Power Management version 3
        Capabilities: [ac] Express Root Port (Slot-), MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [180] Vendor Specific Information: ID=0000 Rev=0 Len=028 &lt;?&gt;
        Capabilities: [240] L1 PM Substates
        Kernel driver in use: pcieport

01:00.0 Non-Volatile memory controller: Toshiba Corporation XG5 NVMe SSD Controller (prog-if 02 [NVM Express])
        Subsystem: Toshiba Corporation XG5 NVMe SSD Controller
        Flags: bus master, fast devsel, latency 0, IRQ 38, NUMA node 0
        Memory at 600000000 (64-bit, non-prefetchable) [size=16K]
        Capabilities: [40] Express Endpoint, MSI 00
        Capabilities: [80] Power Management version 3
        Capabilities: [90] MSI: Enable+ Count=1/32 Maskable+ 64bit+
        Capabilities: [b0] MSI-X: Enable- Count=32 Masked-
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [260] Latency Tolerance Reporting
        Capabilities: [300] Secondary PCI Express
        Capabilities: [400] L1 PM Substates
        Kernel driver in use: nvme
        Kernel modules: nvme

root@debnvme:~# 
</code></pre>
<p><code>smartctl</code> identifies the drive as</p>
<pre><code class="language-text">Model Number:                       KXG50ZNV512G NVMe TOSHIBA 512GB
Serial Number:                      xxxxxxxxxxxx
Firmware Version:                   AADA4106
PCI Vendor/Subsystem ID:            0x1179
IEEE OUI Identifier:                0x00080d
</code></pre>
<h2 id="2023-03-28-serial-debug">2023-03-28 Serial debug</h2>
<p>Serial connection worked with the boot image but produced no output for the Marvell adapter. There was no change with the changes listed below despite power cycling it repeatedly.</p>
<p>Comments per <code>kibi</code> on <code>#debian-raspberrypi</code></p>
<pre><code class="language-text">&lt;kibi&gt; if the kernel doesn't boot, and if it doesn't very early, nearly no chances of getting logs stored onto the internal FS (or external SD card), since / is unlikely to be mounted at this stage
&lt;kibi&gt; anyway:
&lt;kibi&gt; early_con â†’ /etc/default/raspi-extra-cmdline
&lt;kibi&gt; printf &quot;enable_jtag_gpio=1\nforce_turbo=1\n&quot; &gt;&gt; /etc/default/raspi-firmware-custom
&lt;kibi&gt; printf CONSOLES=\&quot;ttyS1,115200\&quot; &gt;&gt; /etc/default/raspi-firmware
</code></pre>
<p>Confirmation</p>
<pre><code class="language-text">root@cm4iob:~# cat /etc/default/raspi-extra-cmdline
early_con
root@cm4iob:~# cat /etc/default/raspi-firmware-custom
enable_jtag_gpio=1
force_turbo=1
root@cm4iob:~# tail /etc/default/raspi-firmware
#KERNEL_ARCH=&quot;arm64&quot;

# Create a file &quot;/etc/default/raspi-firmware-custom&quot; to add custom parameter
# to startup the kernel. Maybe not all options are supported.
# (see https://www.raspberrypi.com/documentation/computers/config_txt.html)
#
# To pass extra arbitrary parameters to the kernel at boot, you can specify
# them in &quot;/etc/default/raspi-extra-cmdline&quot;. Keep in mind they should be
# all in a single line, no comments!
CONSOLES=&quot;ttyS1,115200&quot;root@cm4iob:~# 
root@cm4iob:~# 
</code></pre>
<p>Then run the following. Result will be additional serial debug information and no output to the screen.</p>
<pre><code class="language-text">/etc/initramfs/post-update.d/z50-raspi-firmware
</code></pre>
<h2 id="2023-03-29-focus-on-sd-boot-failure-when-pcie-card-is-present">2023-03-29 focus on SD boot failure when PCIe card is present</h2>
<h3 id="asmedia-pciesata-adapter_1">ASMedia PCIe/SATA adapter</h3>
<p>Successful boot <a href="../dmesg-SD-Debian-ASMedia_successful.txt">dmesg</a> and <a href="../minicom-SD-Debian-ASMedia_success.cap.txt">serial</a></p>
<p>Kernel panic <a href="../minicom-SD-Debian-ASMedia_panic.cap.txt">serial capture</a></p>
<h3 id="marvell-pciesata-adapter">Marvell PCIe/SATA adapter</h3>
<p>Kernel panic, <a href="../minicom-SD_Debian-Marvell-panic.cap.txt">serial capture</a></p>
<h2 id="todo">TODO</h2>
<ul>
<li>~~Report more information on the PCIe/SATA adapters.~~</li>
<li>~~Report <code>dmesg</code> output for various combinations (where boot was successful.)~~</li>
<li>~~Perform serial debug for "didn't boot" scenarios.~~</li>
<li>~~Search for tweaks to boot CM4 from PCIe/SATA.~~</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
